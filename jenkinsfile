pipeline{
    agent{
        label "docker"
    }
    stages{
        stage('Run Docker PS') {
            steps {
                script {
                    // Ejecuta el comando 'docker ps'
                    def dockerPsOutput = sh(script: 'docker ps', returnStdout: true).trim()

                    // Imprime la salida de 'docker ps'
                    echo "Output of 'docker ps':"
                    echo dockerPsOutput
                }
            }
        }


        stage('Build Project') {
            steps {
                script {
                   
                    dir(env.WORKSPACE) {
                        // Ejecuta la tarea del Makefile
                        sh 'make build'
                    }
                }
            }
        }

        stage('Test Unit Project') {
            steps {
                script {
                   
                    dir(env.WORKSPACE) {
                        // Ejecuta la tarea del Makefile
                        sh 'make test-unit'
                    }
                }
            }
        }
        stage('Test Api Project') {
            steps {
                script {
                   
                    dir(env.WORKSPACE) {
                        // Ejecuta la tarea del Makefile
                        sh 'make test-api'
                    }
                }
            }
        }
        stage('Build') {
            steps {
                // Ejecutar tu tarea de construcción aquí
                // ...

                // Después de la construcción, enviar correo electrónico
                emailext(
                    to: 'fabianRBN_95@hotmail.com', // Reemplaza con la dirección de correo electrónico del destinatario
                    subject: 'Notificación de Jenkins',
                    body: 'La construcción ha sido completada exitosamente.',
                    mimeType: 'text/html', // Puedes cambiar a 'text/plain' si prefieres texto sin formato
                    attachLog: true, // Adjunta el registro de la construcción como archivo adjunto
                    compressLog: true, // Comprime el registro de la construcción antes de adjuntarlo
                    replyTo: 'fabian95toapanta@gmail.com', // Dirección de correo electrónico para respuestas
                    from: 'fabian95toapanta@gmail.com' // Dirección de correo electrónico del remitente
                )
            }
        }
    }
    post{
        always{
            echo "========always========"
        }
        success{
            echo "========pipeline executed successfully ========"
        }
        failure{
            echo "========pipeline execution failed========"
        }
    }
}